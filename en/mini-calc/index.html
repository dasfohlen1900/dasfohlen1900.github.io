<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini-Calculator â€” Scientific (.octch)</title>
<link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;600&family=Roboto&display=swap" rel="stylesheet">
<style>
  :root{--bg:#eef4fb;--paper:#fff;--muted:#6b7280;--accent:#0f172a;--panel:#f8fafc}
  html,body{height:100%;margin:0;font-family:Work Sans,Roboto,system-ui,Segoe UI,Arial}
  body{background:linear-gradient(180deg,var(--bg),#fff);display:flex;flex-direction:column;align-items:center;padding:18px;box-sizing:border-box}

  header{width:100%;max-width:980px;display:flex;align-items:center;gap:8px;padding:10px;border-radius:12px;background:var(--paper);box-shadow:0 6px 24px rgba(16,24,40,0.06);margin-bottom:12px;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:10px;font-weight:600;color:var(--accent)}
  .toolbar{display:flex;gap:6px;flex-wrap:wrap;align-items:center;flex:1}
  .btn{background:var(--panel);border:1px solid #e6eef7;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:14px}
  .btn:active{transform:translateY(1px)}
  .small{padding:6px 8px;font-size:13px}

  .layout{width:100%;max-width:980px;display:flex;gap:12px}
  .panel{background:var(--paper);border-radius:10px;padding:12px;box-shadow:0 8px 24px rgba(16,24,40,0.06);min-height:420px;border:1px solid rgba(15,23,42,0.04)}

  .calc{width:560px;display:flex;flex-direction:column;gap:12px}
  .display{background:#fff;border-radius:8px;padding:14px;border:1px solid rgba(15,23,42,0.04);min-height:76px;display:flex;flex-direction:column;justify-content:center}
  .expr{font-size:16px;color:var(--muted);min-height:20px}
  .result{font-size:28px;font-weight:600;color:var(--accent);word-break:break-all}

  .keys{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  .key{padding:12px;border-radius:8px;background:var(--panel);border:1px solid #e6eef7;cursor:pointer;text-align:center;font-weight:600}
  .key.op{background:#fff}
  .key.wide{grid-column:span 2}

  .history{width:320px;display:flex;flex-direction:column;gap:8px}
  .hist-head{display:flex;justify-content:space-between;align-items:center}
  .hist-list{background:linear-gradient(180deg,#fff,#fbfdff);border-radius:8px;padding:8px;overflow:auto;max-height:360px;border:1px solid rgba(15,23,42,0.03)}
  .hist-item{padding:8px;border-radius:6px;margin-bottom:6px;background:var(--panel);cursor:pointer}
  .muted{color:var(--muted)}

  footer{width:100%;max-width:980px;margin-top:10px;display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--muted)}

  @media (max-width:980px){ .layout{flex-direction:column} .history{width:100%} .calc{width:100%} }
</style>
</head>
<body>
<header>
  <div class="brand">ðŸ”¢ Mini-Rechner (wissenschaftlich)</div>
  <div class="toolbar">
    <button class="btn small" onclick="downloadOctch()">ðŸ’¾ History (.octch)</button>
    <button class="btn small" onclick="uploadOctch()">ðŸ“‚ Open</button>
    <input id="openFile" type="file" accept=".octch,.json" style="display:none" onchange="loadOctch(this.files)">
    <button class="btn small" onclick="clearHistory()">ðŸ§¹ Clear history</button>
    <button class="btn small" onclick="toggleRadians()">  RAD/DEG</button>
  </div>
</header>

<div class="layout">
  <section class="panel calc">
    <div class="display">
      <div id="expr" class="expr">0</div>
      <div id="result" class="result">0</div>
    </div>

    <div class="keys" id="keys">
      <!-- Row 1 -->
      <div class="key" onclick="press('(')">(</div>
      <div class="key" onclick="press(')')">)</div>
      <div class="key" onclick="press('pi')">Ï€</div>
      <div class="key" onclick="press('e')">e</div>
      <div class="key op" onclick="press('^')">^</div>
      <div class="key op" onclick="back()">âŒ«</div>

      <!-- Row 2 -->
      <div class="key" onclick="press('sin(')">sin</div>
      <div class="key" onclick="press('cos(')">cos</div>
      <div class="key" onclick="press('tan(')">tan</div>
      <div class="key" onclick="press('sqrt(')">âˆš</div>
      <div class="key op" onclick="press('%')">%</div>
      <div class="key op" onclick="clearEntry()">C</div>

      <!-- Row 3 -->
      <div class="key" onclick="press('7')">7</div>
      <div class="key" onclick="press('8')">8</div>
      <div class="key" onclick="press('9')">9</div>
      <div class="key" onclick="press('/')">Ã·</div>
      <div class="key op" onclick="press('!')">!</div>
      <div class="key op" onclick="press('abs(')">abs</div>

      <!-- Row 4 -->
      <div class="key" onclick="press('4')">4</div>
      <div class="key" onclick="press('5')">5</div>
      <div class="key" onclick="press('6')">6</div>
      <div class="key" onclick="press('*')">Ã—</div>
      <div class="key op" onclick="press('log(')">log</div>
      <div class="key op" onclick="press('ln(')">ln</div>

      <!-- Row 5 -->
      <div class="key" onclick="press('1')">1</div>
      <div class="key" onclick="press('2')">2</div>
      <div class="key" onclick="press('3')">3</div>
      <div class="key" onclick="press('-')">âˆ’</div>
      <div class="key op" onclick="press('^2')">xÂ²</div>
      <div class="key op" onclick="press('^3')">xÂ³</div>

      <!-- Row 6 -->
      <div class="key wide" onclick="press('0')">0</div>
      <div class="key" onclick="press('.')">.</div>
      <div class="key" onclick="press('+')">+</div>
      <div class="key op" onclick="ans()">ANS</div>
      <div class="key op" onclick="equals()">=</div>
    </div>
  </section>

  <aside class="panel history">
    <div class="hist-head">
      <div style="font-weight:600">Verlauf</div>
      <div class="muted">Speichert als <b>.octch</b></div>
    </div>
    <div class="hist-list" id="histList"></div>
  </aside>
</div>

<footer>
  <div class="status" id="status">Bereit</div>
  <div class="muted">EintrÃ¤ge: <span id="histCount">0</span></div>
</footer>

<script>
/* Mini-Rechner (wissenschaftlich)
   - sichere Auswertung von AusdrÃ¼cken (begrenzte erlaubte Funktionen)
   - Verlauf speichern/Ã¶ffnen als .octch (JSON)
   - Autosave (localStorage)
*/

const exprEl = document.getElementById('expr');
const resultEl = document.getElementById('result');
const histList = document.getElementById('histList');
const histCount = document.getElementById('histCount');
const statusEl = document.getElementById('status');
const LS_KEY = 'minirechner_octch_v1';
let expr = '';
let lastAns = 0;
let history = [];
let useRadians = true;

// Allowed names mapped to Math
const funcs = {
  sin: v => Math.sin(useRadians? v: v * Math.PI/180),
  cos: v => Math.cos(useRadians? v: v * Math.PI/180),
  tan: v => Math.tan(useRadians? v: v * Math.PI/180),
  sqrt: v => Math.sqrt(v),
  abs: v => Math.abs(v),
  log: v => Math.log10(v),
  ln: v => Math.log(v)
};

function refreshDisplay(){
  exprEl.textContent = expr || '0';
  try{ const r = evaluate(expr); resultEl.textContent = String(r); }catch(e){ resultEl.textContent = 'â€”'; }
}

function press(token){
  // map display tokens
  if(token === 'pi') token = 'PI';
  if(token === 'e') token = 'E';
  expr += token;
  refreshDisplay();
}
function back(){ expr = expr.slice(0,-1); refreshDisplay(); }
function clearEntry(){ expr = ''; refreshDisplay(); }

function ans(){ expr += String(lastAns); refreshDisplay(); }

function equals(){
  try{
    const r = evaluate(expr);
    lastAns = r;
    addHistory(expr, r);
    expr = String(r);
    refreshDisplay();
    status('Ergebnis berechnet');
  }catch(e){ status('UngÃ¼ltiger Ausdruck'); }
}

function factorial(n){ if(n<0) return NaN; if(n===0) return 1; let f=1; for(let i=1;i<=n;i++) f*=i; return f; }

// Secure evaluator: only allow digits, operators, parentheses, decimals, PI, E, function names, comma, spaces
function sanitize(input){
  // replace unicode minus
  input = input.replace(/â€“/g,'-');
  // allow only certain characters and letters for functions
  if(/[^0-9+\-*/%^()., PIEna-zA-Z!_\s]/.test(input)) throw new Error('UngÃ¼ltige Zeichen');
  return input;
}

function evaluate(input){
  if(!input || input.trim()==='') return 0;
  let s = sanitize(input);
  // replacements
  s = s.replace(/PI/g, String(Math.PI));
  s = s.replace(/E/g, String(Math.E));
  // handle factorial '!' (apply to previous number or parenthesis)
  s = s.replace(/(\d+(?:\.\d+)?|\))!/g, function(m, p1){ if(p1===')') return ')!'; return 'fact('+p1+')'; });
  // replace ^ with **
  s = s.replace(/\^/g,'**');
  // replace functions with calls to our funcs via __f('name',args)
  s = s.replace(/([a-zA-Z_][a-zA-Z0-9_]*)\s*\(/g, function(_, name){ if(funcs[name]) return `__f('${name}',(`; return name+'('; });
  // replace factorial placeholder )! with applying fact to group
  s = s.replace(/\)!/g, '); __f_fact_marker');

  // Build a safe Function with only required helpers
  const body = `
    const __f = function(name,args){ return ({${Object.keys(funcs).map(n=>n+':null').join(',')}})[name]; };
  `;
  // Instead of trying to patch into the string, we'll implement a safer interpreter: use Function but with replacements to direct Math/functions
  // Simpler: create mapping for function names to Math wrappers in scope
  const scope = Object.assign({}, funcs);
  scope.fact = factorial;

  // For evaluation, create a Function with allowed names as local variables
  const allowedNames = Object.keys(scope);
  const args = allowedNames.join(',');
  const vals = allowedNames.map(n=>scope[n]);
  // final expression: use eval via Function returning expression
  // ensure no semicolons
  const finalExpr = s.replace(/__f\('([a-zA-Z_][a-zA-Z0-9_]*)',\(/g, (_,name)=>`${name}(`).replace(/\)\; __f_fact_marker/g, ')');
  // Now create function
  const fn = new Function(args, `return (${finalExpr});`);
  const result = fn(...vals);
  // handle percent: if expression contains % treat as divide by 100 where appropriate
  if(typeof result === 'number' && !isFinite(result)) throw new Error('Result not finite');
  return result;
}

function addHistory(equ, res){
  const item = {expr:equ, result:res, time: new Date().toISOString()};
  history.unshift(item);
  renderHistory();
  scheduleSave();
}

function renderHistory(){
  histList.innerHTML = '';
  history.forEach((h,i)=>{
    const d = document.createElement('div'); d.className='hist-item';
    d.innerHTML = `<div style="font-weight:600">${h.expr}</div><div class="muted">= ${h.result} Â· ${new Date(h.time).toLocaleString()}</div>`;
    d.onclick = ()=>{ expr = String(h.result); refreshDisplay(); };
    histList.appendChild(d);
  });
  histCount.textContent = history.length;
}

function scheduleSave(){
  clearTimeout(window._saveTimer);
  window._saveTimer = setTimeout(()=>{
    localStorage.setItem(LS_KEY, JSON.stringify({history, lastAns, useRadians}));
    status('Gespeichert');
  },600);
}

function loadFromStorage(){
  const s = localStorage.getItem(LS_KEY);
  if(s){ try{ const o = JSON.parse(s); history = o.history||[]; lastAns = o.lastAns||0; useRadians = o.useRadians!==undefined? o.useRadians:true; renderHistory(); }catch(e){} }
}
loadFromStorage();

function downloadOctch(){
  const name = 'verlauf.octch';
  const blob = new Blob([JSON.stringify(history, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),2000);
  status('Heruntergeladen: ' + name);
}
function uploadOctch(){ document.getElementById('openFile').click(); }
function loadOctch(files){ const f = files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ try{ const o = JSON.parse(r.result); if(Array.isArray(o)){ history = o; renderHistory(); scheduleSave(); status('Verlauf geladen'); } else { status('UngÃ¼ltiges Format'); } }catch(e){ status('Fehler beim Laden'); } }; r.readAsText(f); document.getElementById('openFile').value=''; }

function clearHistory(){ if(confirm('Verlauf wirklich lÃ¶schen?')){ history = []; renderHistory(); scheduleSave(); status('Verlauf gelÃ¶scht'); } }

function status(t){ statusEl.textContent = t; }

function toggleRadians(){ useRadians = !useRadians; status('Modus: ' + (useRadians? 'Radians':'Degrees')); scheduleSave(); }

// keyboard support
document.addEventListener('keydown', e=>{
  if(e.key === 'Enter'){ e.preventDefault(); equals(); }
  if(e.key === 'Backspace'){ back(); }
  if(/^[0-9+\-*/().^]$/.test(e.key)) { press(e.key); }
});

// expose functions to buttons
window.press = press; window.back = back; window.clearEntry = clearEntry; window.equals = equals; window.ans = ans;
window.downloadOctch = downloadOctch; window.uploadOctch = uploadOctch; window.loadOctch = loadOctch; window.clearHistory = clearHistory; window.toggleRadians = toggleRadians;

// initial
refreshDisplay(); renderHistory();
</script>
</body>
</html>
